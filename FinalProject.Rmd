---
title: "Final Project"
author: "Yunqiu Yao, Cenai Zhang, Yutian Mu, Murrel Pereira"
date: "12/9/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(olsrr)
```

```{r}
### clean the date
gh = read_excel("./GHProject_Dataset.xlsx") %>% 
  clean_names %>% 
  separate(admitdtm, c("admit_dow","date","year"), ",") %>% 
  mutate(date = trimws(date, "left")) %>% 
  separate(date,c("month","sdate")," ") %>% 
  mutate(month = as.numeric(match(month,month.name)),
         sdate = as.numeric(sdate),
         year = as.numeric(year),
         admit_date = paste(month, sdate, year, sep="-"),
         admit_date = as.Date(admit_date, "%m-%d-%Y")) %>%
  select(-c(sdate,year,month)) %>% 
  mutate(log_losday = log(losdays2))

### remove the duplicate visits
gh = gh[order(gh$admit_date),]
gh_unique <- gh[!duplicated(gh$patientid),]

### recode the levels of categorical variables
gh_tidy = gh_unique %>% 
  mutate(mews = as.factor(ifelse(mews <= 1, "normal", ifelse(mews <= 3, "increase caution", ifelse(mews <= 5, "further deterioration", "immediate action required")))),
         cindex = as.factor(ifelse(cindex == 0, "normal", ifelse(cindex <= 2, "mild", ifelse(cindex <= 4, "moderate", "severe")))),
         is30dayreadmit = as.factor(is30dayreadmit),
         icu_flag = as.factor(icu_flag)) %>% 
  select(log_losday, losdays2, patientid, visitid, admit_date, admit_dow, everything(), -loshours, -facilityname, -facilityzip, -postalcode)


```


```{r}
#Descriptive Statistics
summary(gh_tidy)

gh_tidy$gender[gh_tidy$gender == "Male"] = 0
gh_tidy$gender[gh_tidy$gender == "Female"] = 1

par(mfrow = c(1, 2))
hist(gh_tidy$losdays2, main = "Length of Stay")
hist(gh_tidy$log_losday, main = "Log Length of Stay")

par(mfrow = c(1, 2))
barplot(table(gh_tidy$admit_dow), las = 2, main = "Day of Week Frequency")
barplot(table(gh_tidy$is30dayreadmit), las = 1, main = "Is patient 30 day readmit?")
barplot(table(gh_tidy$mews), las = 2, main = "Modified Early Warning Score (MEWS)")
barplot(table(gh_tidy$cindex), las = 2, main = "Charlson comorbidity index (CCI)")


barplot(table(gh_tidy$icu_flag), main = "If patient visited ICU")
barplot(table(gh_tidy$gender), main = "Gender")
barplot(table(gh_tidy$race), las =2, main = "Race Frequency")
barplot(table(gh_tidy$religion), las = 2, main = "Religion Frequency")
barplot(table(gh_tidy$maritalstatus), las = 2, main = "Marital Status Frequency")
barplot(table(gh_tidy$insurancetype), las = 1, main = "Insurance Type")

par(mfrow = c(3, 3))
hist(gh_tidy$evisit, main = "ER visits in past 6 months")
hist(gh_tidy$ageyear, main ="Age Histogram") #might need a log transformation
hist(gh_tidy$bmi, main = "BMI")
hist(gh_tidy$bpsystolic, main = "BP Systolic") #120 - 140 mmHg normal range
hist(gh_tidy$bpdiastolic, main = "BP Diastolic") #80 -90 mmHg normal range
hist(gh_tidy$o2sat, main = "O2 Saturation") #Normal is  <100 - check for outliers
hist(gh_tidy$temperature, main = "Temperature") #Normal range is 36.1 C - 37.2 C - check for outliers; can go upto 42C
hist(gh_tidy$heartrate, main = "Heart Rate") #40 - 100 beats per minute
hist(gh_tidy$respirationrate, main = "Respiration Rate") #12 - 25 breaths per minute in normal adult


gh_tidy$temperature[gh_tidy$temperature < 36] <- NA
gh_tidy$temperature[gh_tidy$temperature > 42] <- NA
gh_tidy$o2sat[gh_tidy$o2sat > 100] <- NA


par(mfrow = c(1, 2))
hist(gh_tidy$o2sat, main = "O2 Saturation") #Normal is  <100 - check for outliers
hist(gh_tidy$temperature, main = "Temperature")

class(gh_tidy$gender) <- "binary"
class(gh_tidy$icu_flag) <- "binary"
class(gh_tidy$is30dayreadmit) <- "binary"

```

```{r}
gh_reg = gh_tidy %>%
  select(-losdays2, -patientid, -visitid, -admit_date, -bmi) %>%
  na.omit()

#fit models
model <- lm(gh_reg$log_losday~ ., data = gh_reg)
summary(model)


```


```{r}


model_forward <- ols_step_forward(model, penter = 0.20)
model_backward <- ols_step_backward(model, penter = 0.20)
reg_forward<-lm(gh_reg$log_losday ~ ageyear + evisit + bpsystolic + heartrate + respirationrate + is30dayreadmit + bpdiastolic + gender + temperature + admit_dow, data = gh_reg)
summary(reg_forward)

#1
model_stepwise <- ols_stepwise(model, pent = 0.20, prem = 0.20)
model_stepwise$predictors

stepwise_model1 <- lm(gh_reg$log_losday ~ ageyear + evisit + bpsystolic + heartrate + respirationrate + is30dayreadmit + bpdiastolic + gender + temperature + admit_dow + race + religion + icu_flag + o2sat + maritalstatus + insurancetype + mews, data = gh_reg ) 
summary(stepwise_model1)

#2
step(model, direction = 'backward')
stepwise_model2 <- lm(gh_reg$log_losday ~ admit_date + admit_dow + is30dayreadmit + 
    mews + cindex + evisit + icu_flag + ageyear + gender + maritalstatus + 
    insurancetype + bmi + bpsystolic + o2sat + temperature + 
    heartrate + respirationrate + bpdiastolic, data = gh_reg, na.rm = TRUE) 
summary(stepwise_model2 )
```

```{r}
#backward
step(model, direction = 'backward')
summary(lm(formula = gh_reg$log_losday ~ is30dayreadmit + cindex + evisit + 
    ageyear + gender + maritalstatus + insurancetype + bpsystolic + 
    o2sat + temperature + heartrate + respirationrate + bpdiastolic, 
    data = gh_reg))

#both 
step(model, direction = 'both')
summary(lm(formula = gh_reg$log_losday ~ is30dayreadmit + cindex + evisit + 
    ageyear + gender + maritalstatus + insurancetype + bpsystolic + 
    o2sat + temperature + heartrate + respirationrate + bpdiastolic, 
    data = gh_reg))

#forward
step(model, direction = 'forward')
summary(lm(formula = gh_reg$log_losday ~ admit_dow + is30dayreadmit + 
    mews + cindex + evisit + icu_flag + ageyear + gender + race + 
    religion + maritalstatus + insurancetype + bpsystolic + o2sat + 
    temperature + heartrate + respirationrate + bpdiastolic, 
    data = gh_reg))
```


```{r}
#best model

best <- function(model, ...) 
{
  subsets <- regsubsets(formula(model), model.frame(model), ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  

```


```{r}
#try transformation of the outcome
gh %>%
ggplot(aes(x = losdays2)) +  geom_histogram()

gh %>%
ggplot(aes(x = log(losdays2))) +  geom_histogram()
```


