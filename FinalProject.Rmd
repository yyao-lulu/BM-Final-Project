---
title: "Final Project"
author: "Yunqiu Yao, Cenai Zhang, Yutian Mu, Murrel Pereira"
date: "12/9/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(olsrr)
```

```{r}
### clean the date
gh = read_excel("./GHProject_Dataset.xlsx") %>% 
  clean_names %>% 
  separate(admitdtm, c("admit_dow","date","year"), ",") %>% 
  mutate(date = trimws(date, "left")) %>% 
  separate(date,c("month","sdate")," ") %>% 
  mutate(month = as.numeric(match(month,month.name)),
         sdate = as.numeric(sdate),
         year = as.numeric(year),
         admit_date = paste(month, sdate, year, sep="-"),
         admit_date = as.Date(admit_date, "%m-%d-%Y")) %>%
  select(-c(sdate,year,month)) %>% 
  mutate(log_losday = log(losdays2))

### remove the duplicate visits
gh = gh[order(gh$admit_date),]
gh_unique <- gh[!duplicated(gh$patientid),]

### recode the levels of categorical variables
gh_tidy = gh_unique %>% 
  mutate(mews = as.factor(ifelse(mews <= 1, "normal", ifelse(mews <= 3, "increase caution", ifelse(mews <= 5, "further desterioration", "immediate action required")))),
         cindex = as.factor(ifelse(cindex == 0, "normal", ifelse(cindex <= 2, "mild", ifelse(cindex <= 4, "moderate", "severe")))),
         is30dayreadmit = as.factor(is30dayreadmit),
         icu_flag = as.factor(icu_flag)) %>% 
  select(log_losday, losdays2, patientid, visitid, admit_date, admit_dow, everything(), -loshours, -facilityname, -facilityzip, -postalcode)

gh_reg = gh_tidy %>%
  select(-losdays2, -patientid, -visitid)
```

```{r}
#fit models
model <- lm(gh_reg$log_losday~ ., data = gh_reg)

model_forward <- ols_step_forward(model, penter = 0.20)
model_backward <- ols_step_backward(model, penter = 0.20)
reg_forward<-lm(gh_reg$log_losday ~ ageyear + evisit + bpsystolic + heartrate + respirationrate + is30dayreadmit + bpdiastolic + gender + temperature + admit_dow, data = gh_reg)
summary(reg_forward)

#1
model_stepwise <- ols_stepwise(model, pent = 0.20, prem = 0.20)
model_stepwise$predictors

stepwise_model1 <- lm(gh_reg$log_losday ~ ageyear + evisit + bpsystolic + heartrate + respirationrate + is30dayreadmit + bpdiastolic + gender + temperature + admit_dow + race + religion + icu_flag + o2sat + maritalstatus + insurancetype + mews, data = gh_reg ) 
summary(stepwise_model1)

#2
step(model, direction = 'backward')
stepwise_model2 <- lm(gh_reg$log_losday ~ admit_date + admit_dow + is30dayreadmit + 
    mews + cindex + evisit + icu_flag + ageyear + gender + maritalstatus + 
    insurancetype + bmi + bpsystolic + o2sat + temperature + 
    heartrate + respirationrate + bpdiastolic, data = gh_reg, na.rm = TRUE) 
summary(stepwise_model2 )
```





```{r}
#try transformation of the outcome
gh %>%
ggplot(aes(x = losdays2)) +  geom_histogram()

gh %>%
ggplot(aes(x = log(losdays2))) +  geom_histogram()
```


